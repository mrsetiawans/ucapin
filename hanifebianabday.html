<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Untuk Hani Febiana - Selamat Ulang Tahun</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;1,300;1,400&family=Nunito:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --night-deep: #0a0f1a;
            --night-purple: #1a1528;
            --garden-green: #1a2f20;
            --firefly-gold: #f4d35e;
            --firefly-warm: #fae588;
            --petal-pink: #f4a5c0;
            --cream: #fefbf3;
            --soft-lavender: #e8dff0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Nunito', sans-serif;
            background: var(--night-deep);
            color: var(--cream);
            touch-action: none;
            user-select: none;
        }

        #world {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            background: radial-gradient(ellipse at 50% 50%, transparent 40%, rgba(10, 15, 26, 0.7) 100%);
        }

        #ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .pointer-active {
            pointer-events: auto;
        }

        /* ===== COUNTDOWN SCREEN ===== */
        #countdown-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 150;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            background: linear-gradient(180deg, 
                #0a0f1a 0%, 
                #1a1528 50%, 
                #1a2f20 100%
            );
        }

        .countdown-content {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeUp 1s ease forwards;
        }

        .countdown-content:nth-child(1) { animation-delay: 0.1s; }
        .countdown-content:nth-child(2) { animation-delay: 0.3s; }
        .countdown-content:nth-child(3) { animation-delay: 0.5s; }
        .countdown-content:nth-child(4) { animation-delay: 0.7s; }

        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .countdown-icon {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            animation: glowPulse 3s infinite ease-in-out;
        }

        @keyframes glowPulse {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(244, 211, 94, 0.5)); }
            50% { filter: drop-shadow(0 0 25px rgba(244, 211, 94, 0.9)); }
        }

        .countdown-title {
            font-family: 'Crimson Pro', serif;
            font-weight: 300;
            font-size: clamp(1.4rem, 5vw, 2.2rem);
            color: var(--cream);
            letter-spacing: 0.08em;
            margin-bottom: 0.3rem;
        }

        .countdown-subtitle {
            font-family: 'Nunito', sans-serif;
            font-weight: 300;
            font-size: clamp(0.7rem, 2.5vw, 0.85rem);
            color: var(--firefly-gold);
            letter-spacing: 0.3em;
            text-transform: uppercase;
            margin-bottom: 2.5rem;
            opacity: 0.9;
        }

        .countdown-timer {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 2.5rem;
        }

        .countdown-item {
            background: rgba(244, 211, 94, 0.08);
            border: 1px solid rgba(244, 211, 94, 0.2);
            border-radius: 16px;
            padding: 18px 14px;
            min-width: 65px;
        }

        .countdown-number {
            font-family: 'Crimson Pro', serif;
            font-size: clamp(1.8rem, 7vw, 2.5rem);
            font-weight: 400;
            color: var(--firefly-warm);
            line-height: 1;
        }

        .countdown-label {
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--cream);
            opacity: 0.6;
            margin-top: 6px;
        }

        .countdown-message {
            font-family: 'Crimson Pro', serif;
            font-style: italic;
            font-size: clamp(0.9rem, 3.2vw, 1.05rem);
            line-height: 1.9;
            color: var(--soft-lavender);
            max-width: 380px;
            opacity: 0.85;
        }

        /* Floating fireflies for countdown */
        .firefly-bg {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--firefly-gold);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--firefly-gold), 0 0 20px var(--firefly-gold);
            animation: fireflyFloat 8s infinite ease-in-out;
            opacity: 0;
        }

        @keyframes fireflyFloat {
            0%, 100% { 
                opacity: 0;
                transform: translate(0, 0);
            }
            20% { opacity: 0.8; }
            80% { opacity: 0.8; }
            50% {
                transform: translate(calc(var(--dx) * 1px), calc(var(--dy) * 1px));
            }
        }

        /* ===== INTRO SCREEN ===== */
        #intro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            background: radial-gradient(ellipse at 50% 70%, 
                rgba(26, 47, 32, 0.9) 0%, 
                rgba(26, 21, 40, 0.95) 50%,
                rgba(10, 15, 26, 1) 100%
            );
        }

        .intro-content {
            opacity: 0;
            transform: translateY(25px);
            animation: fadeUp 1.2s ease forwards;
        }

        .intro-content:nth-child(1) { animation-delay: 0.2s; }
        .intro-content:nth-child(2) { animation-delay: 0.4s; }
        .intro-content:nth-child(3) { animation-delay: 0.6s; }
        .intro-content:nth-child(4) { animation-delay: 0.8s; }
        .intro-content:nth-child(5) { animation-delay: 1s; }

        .title-main {
            font-family: 'Crimson Pro', serif;
            font-weight: 300;
            font-size: clamp(1.8rem, 7vw, 3rem);
            color: var(--cream);
            letter-spacing: 0.06em;
            margin-bottom: 0.2rem;
        }

        .title-age {
            font-family: 'Crimson Pro', serif;
            font-weight: 400;
            font-size: clamp(2.5rem, 10vw, 4rem);
            background: linear-gradient(135deg, var(--firefly-gold), var(--petal-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            margin-bottom: 0.3rem;
        }

        .title-sub {
            font-family: 'Nunito', sans-serif;
            font-weight: 300;
            font-size: clamp(0.65rem, 2.3vw, 0.8rem);
            color: var(--petal-pink);
            letter-spacing: 0.35em;
            text-transform: uppercase;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .intro-poem {
            font-family: 'Crimson Pro', serif;
            font-style: italic;
            font-weight: 300;
            font-size: clamp(0.9rem, 3.3vw, 1.1rem);
            line-height: 2;
            color: var(--soft-lavender);
            max-width: 400px;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .btn-begin {
            font-family: 'Nunito', sans-serif;
            font-weight: 400;
            font-size: 0.75rem;
            letter-spacing: 0.28em;
            text-transform: uppercase;
            color: var(--night-deep);
            background: linear-gradient(135deg, var(--firefly-gold), var(--firefly-warm));
            border: none;
            padding: 16px 40px;
            cursor: pointer;
            transition: all 0.4s ease;
            border-radius: 50px;
            box-shadow: 0 4px 25px rgba(244, 211, 94, 0.3);
        }

        .btn-begin:hover,
        .btn-begin:active {
            transform: scale(1.03);
            box-shadow: 0 6px 35px rgba(244, 211, 94, 0.5);
        }

        /* ===== HUD ===== */
        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 22px 25px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            opacity: 0;
            transition: opacity 1s ease;
            z-index: 15;
        }

        #hud.visible { opacity: 1; }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(10, 15, 26, 0.6);
            padding: 10px 16px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }

        .firefly-icon {
            font-size: 1rem;
            animation: glowPulse 2s infinite;
        }

        .progress-text {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--firefly-warm);
        }

        .sound-toggle {
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 50%;
            background: rgba(10, 15, 26, 0.6);
            backdrop-filter: blur(10px);
            color: var(--cream);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .sound-toggle:hover {
            background: rgba(244, 211, 94, 0.2);
        }

        /* ===== DIALOGUE BOX ===== */
        #dialogue {
            position: fixed;
            bottom: 6%;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 36px);
            max-width: 520px;
            background: rgba(10, 15, 26, 0.92);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(244, 211, 94, 0.15);
            border-radius: 20px;
            padding: 26px 28px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            z-index: 20;
        }

        #dialogue.visible {
            opacity: 1;
            visibility: visible;
        }

        #dialogue.is-doa {
            border-color: rgba(244, 165, 192, 0.25);
            background: rgba(26, 21, 40, 0.95);
        }

        .dialogue-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Nunito', sans-serif;
            font-weight: 400;
            font-size: 0.6rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--firefly-gold);
            margin-bottom: 14px;
            opacity: 0.9;
        }

        .dialogue-header-icon {
            font-size: 0.8rem;
        }

        .dialogue-body {
            font-family: 'Crimson Pro', serif;
            font-size: clamp(0.95rem, 3.6vw, 1.12rem);
            line-height: 1.85;
            color: var(--cream);
            min-height: 70px;
        }

        .dialogue-continue {
            position: absolute;
            bottom: 10px;
            right: 16px;
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            color: var(--firefly-gold);
            opacity: 0;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .dialogue-continue.visible {
            opacity: 0.6;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.7; }
        }

        /* ===== END SCREEN ===== */
        #ending {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 25px;
            background: radial-gradient(ellipse at 50% 50%, 
                rgba(26, 21, 40, 0.98) 0%, 
                rgba(10, 15, 26, 1) 100%
            );
            opacity: 0;
            pointer-events: none;
            transition: opacity 2s ease;
            overflow-y: auto;
        }

        #ending.active {
            opacity: 1;
            pointer-events: auto;
        }

        .ending-card {
            max-width: 480px;
            opacity: 0;
            transform: translateY(35px);
            transition: all 1.5s ease 0.5s;
            padding: 15px 0;
        }

        #ending.active .ending-card {
            opacity: 1;
            transform: translateY(0);
        }

        .ending-fireflies {
            font-size: 2rem;
            margin-bottom: 1.2rem;
            letter-spacing: 8px;
        }

        .ending-title {
            font-family: 'Crimson Pro', serif;
            font-weight: 300;
            font-size: clamp(1.5rem, 5.5vw, 2rem);
            color: var(--cream);
            margin-bottom: 0.2rem;
            letter-spacing: 0.05em;
        }

        .ending-subtitle {
            font-family: 'Nunito', sans-serif;
            font-weight: 300;
            font-size: 0.7rem;
            letter-spacing: 0.28em;
            text-transform: uppercase;
            color: var(--firefly-gold);
            margin-bottom: 1.8rem;
            opacity: 0.9;
        }

        .ending-message {
            font-family: 'Crimson Pro', serif;
            font-size: clamp(0.9rem, 3.3vw, 1.02rem);
            line-height: 2;
            color: var(--soft-lavender);
            margin-bottom: 1.8rem;
        }

        .ending-signature {
            font-family: 'Crimson Pro', serif;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--petal-pink);
            opacity: 0.8;
        }

        .btn-restart {
            margin-top: 1.8rem;
            font-family: 'Nunito', sans-serif;
            font-size: 0.65rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--cream);
            background: transparent;
            border: 1px solid rgba(244, 211, 94, 0.3);
            padding: 12px 28px;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.4s ease;
            border-radius: 30px;
        }

        .btn-restart:hover {
            opacity: 1;
            border-color: var(--firefly-gold);
            background: rgba(244, 211, 94, 0.1);
        }

        /* Control Hint */
        .control-hint {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            color: rgba(254, 251, 243, 0.35);
            z-index: 12;
            transition: opacity 2s ease;
        }

        .control-hint.hidden { opacity: 0; }

        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: middle;
        }

    </style>
</head>
<body>

    <div id="world"></div>
    <div class="vignette"></div>

    <div id="ui">
        <!-- Countdown Screen -->
        <div id="countdown-screen" class="pointer-active">
            <!-- Background fireflies -->
            <div class="firefly-bg" style="top: 15%; left: 10%; --dx: 30; --dy: -20; animation-delay: 0s;"></div>
            <div class="firefly-bg" style="top: 25%; left: 85%; --dx: -25; --dy: 15; animation-delay: 1s;"></div>
            <div class="firefly-bg" style="top: 60%; left: 20%; --dx: 20; --dy: -30; animation-delay: 2s;"></div>
            <div class="firefly-bg" style="top: 70%; left: 75%; --dx: -35; --dy: -10; animation-delay: 3s;"></div>
            <div class="firefly-bg" style="top: 40%; left: 50%; --dx: 15; --dy: 25; animation-delay: 4s;"></div>
            <div class="firefly-bg" style="top: 80%; left: 40%; --dx: -20; --dy: -25; animation-delay: 5s;"></div>

            <div class="countdown-icon countdown-content">âœ¨</div>
            <h1 class="countdown-title countdown-content">Menunggu Malam Spesial</h1>
            <p class="countdown-subtitle countdown-content">3 Juni 2026</p>
            
            <div class="countdown-timer countdown-content">
                <div class="countdown-item">
                    <div class="countdown-number" id="days">00</div>
                    <div class="countdown-label">Hari</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-number" id="hours">00</div>
                    <div class="countdown-label">Jam</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-number" id="minutes">00</div>
                    <div class="countdown-label">Menit</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-number" id="seconds">00</div>
                    <div class="countdown-label">Detik</div>
                </div>
            </div>

            <p class="countdown-message countdown-content">
                "Di taman yang sunyi, kunang-kunang sedang<br>
                merangkai cahaya menjadi kata-kata.<br>
                Tunggu sebentar lagi, ya?"
            </p>
        </div>

        <!-- Intro Screen -->
        <div id="intro" class="pointer-active">
            <h1 class="title-main intro-content">Selamat Ulang Tahun</h1>
            <div class="title-age intro-content" id="ageDisplay">âœ¦</div>
            <p class="title-sub intro-content">Hani Febiana â€¢ dari Rizal</p>
            
            <p class="intro-poem intro-content">
                Malam ini taman dipenuhi cahaya kecil,<br>
                setiap kunang-kunang membawa sepenggal cerita.<br>
                Maukah kau menangkap mereka bersamaku?
            </p>
            
            <button class="btn-begin intro-content pointer-active" id="btnStart">
                Masuk ke Taman
            </button>
        </div>

        <!-- HUD -->
        <div id="hud">
            <div class="progress-container">
                <span class="firefly-icon">âœ¦</span>
                <span class="progress-text" id="progressText">0 / 9</span>
            </div>
            <button class="sound-toggle pointer-active" id="btnSound">
                <svg class="icon" id="iconSound" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
            </button>
        </div>

        <!-- Dialogue -->
        <div id="dialogue" class="pointer-active">
            <div class="dialogue-header">
                <span class="dialogue-header-icon" id="dialogueIcon">âœ¦</span>
                <span id="dialogueLabel">Rizal berbisik:</span>
            </div>
            <div class="dialogue-body" id="dialogueText"></div>
            <div class="dialogue-continue" id="btnContinue">ketuk untuk lanjut â†’</div>
        </div>

        <!-- Control Hint -->
        <div class="control-hint" id="controlHint">
            sentuh kunang-kunang untuk menangkapnya
        </div>

        <!-- Ending -->
        <div id="ending">
            <div class="ending-card">
                <div class="ending-fireflies">âœ¦ âœ¦ âœ¦</div>
                <h1 class="ending-title">Selamat Ulang Tahun, Hani</h1>
                <p class="ending-subtitle">Cahaya di Malamku</p>
                
                <p class="ending-message">
                    Semua kunang-kunang sudah berkumpul,<br>
                    dan mereka membentuk satu pesan sederhana:<br><br>
                    <em>"Aku bersyukur kau ada."</em><br><br>
                    Terima kasih sudah menjadi cahaya<br>
                    di malam-malam yang gelap.<br>
                    Semoga Allah selalu menerangi jalanmu,<br>
                    seperti kau menerangi hidupku.
                </p>
                
                <p class="ending-signature">â€” Selamanya milikmu, Rizal â€”</p>
                
                <button class="btn-restart pointer-active" onclick="location.reload()">
                    Kembali ke Taman
                </button>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // CONFIG
        // =========================================================================
        
        const BIRTHDAY = new Date('2025-06-03T00:00:00');
        
        function calculateAge() {
            const birthYear = 2005;
            return BIRTHDAY.getFullYear() - birthYear;
        }

        // =========================================================================
        // MESSAGES
        // =========================================================================
        
        const messages = [
            {
                type: 'message',
                text: "Hani... Setiap malam aku memandang langit, dan entah kenapa bintang-bintang selalu mengingatkanku padamu. Mungkin karena kau adalah cahaya yang samaâ€”jauh, tapi selalu terasa dekat di hati."
            },
            {
                type: 'message',
                text: "Setahun lagi kita berjalan bersama. Ada tawa, ada tangis, ada sunyi yang kita lalui berdua. Dan di setiap langkahnya, aku semakin yakinâ€”kau adalah pilihan yang tidak pernah kusesali."
            },
            {
                type: 'message',
                text: "Aku bukan lelaki sempurna. Ada hari di mana aku lupa mendengarkan, lupa bertanya kabarmu, lupa bahwa kau juga butuh disandarkan. Maafkan aku untuk hari-hari itu."
            },
            {
                type: 'message',
                text: "Tapi di hari ini, aku ingin kau tahuâ€”kau adalah alasan aku ingin menjadi lebih baik. Bukan untuk siapa-siapa, tapi untukmu. Untuk kita."
            },
            {
                type: 'message',
                text: "Di usia yang baru ini, jangan lupa untuk bangga pada dirimu sendiri. Kau sudah melewati begitu banyak hal, dan kau masih di siniâ€”masih berdiri, masih tersenyum. Itu bukan hal kecil."
            },
            {
                type: 'message',
                text: "Aku berjanji akan terus belajar mencintaimu. Bukan dengan cara yang sempurna, tapi dengan cara yang jujur. Yang hadir saat kau butuh, yang diam saat kau ingin sendiri, yang mengerti tanpa harus dijelaskan."
            },
            {
                type: 'doa',
                text: "Ya Allah, di malam yang penuh berkah ini, aku memohon kepada-Muâ€”limpahkanlah kebahagiaan untuk Hani. Jauhkan ia dari kesedihan yang berkepanjangan, dan dekatkan ia pada segala hal yang membuatnya tersenyum."
            },
            {
                type: 'doa',
                text: "Ya Rahman Ya Rahim, jika kami memang ditakdirkan untuk bersamaâ€”satukanlah kami dalam ikatan yang Kau ridhai. Jadikan cinta ini bukan sekadar perasaan, tapi jalan ibadah yang membawa kami mendekat kepada-Mu."
            },
            {
                type: 'doa',
                text: "Ya Rabb, aku titipkan Hani dalam penjagaan-Mu yang Maha Sempurna. Jaga hatinya, jaga langkahnya, jaga mimpi-mimpinya. Dan jika Engkau izinkan aku menemaninyaâ€”jadikan aku pelindung yang amanah, dan imam yang membimbingnya menuju ridha-Mu. Aamiin ya Rabbal'alamin."
            }
        ];

        // =========================================================================
        // STATE
        // =========================================================================
        
        const state = {
            isPlaying: false,
            score: 0,
            maxScore: messages.length,
            dialogueOpen: false,
            isMuted: false,
            isUnlocked: false,
            mouseX: 0,
            mouseY: 0
        };

        // =========================================================================
        // COUNTDOWN
        // =========================================================================
        
        function updateCountdown() {
            const now = new Date();
            const diff = BIRTHDAY - now;

            if (diff <= 0) {
                state.isUnlocked = true;
                document.getElementById('countdown-screen').style.display = 'none';
                document.getElementById('intro').style.display = 'flex';
                document.getElementById('ageDisplay').textContent = calculateAge();
                return true;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('days').textContent = String(days).padStart(2, '0');
            document.getElementById('hours').textContent = String(hours).padStart(2, '0');
            document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
            document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');

            return false;
        }

        function startCountdown() {
            if (!updateCountdown()) {
                setInterval(updateCountdown, 1000);
            }
        }

        // =========================================================================
        // THREE.JS SETUP
        // =========================================================================
        
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0f1a);
        scene.fog = new THREE.FogExp2(0x0a0f1a, 0.015);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 8);

        const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('world').appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x1a1528, 0.8);
        scene.add(ambientLight);

        const moonLight = new THREE.DirectionalLight(0x6677aa, 0.3);
        moonLight.position.set(5, 10, 5);
        scene.add(moonLight);

        // =========================================================================
        // TEXTURES
        // =========================================================================
        
        function createGlowTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            
            const grad = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            grad.addColorStop(0, color);
            grad.addColorStop(0.3, color.replace('1)', '0.6)'));
            grad.addColorStop(0.6, color.replace('1)', '0.2)'));
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, 64, 64);
            
            return new THREE.CanvasTexture(canvas);
        }

        function createGrassTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            // Base color
            ctx.fillStyle = '#0d1a12';
            ctx.fillRect(0, 0, 256, 256);
            
            // Grass blades
            for (let i = 0; i < 500; i++) {
                const x = Math.random() * 256;
                const y = Math.random() * 256;
                const height = 5 + Math.random() * 15;
                const hue = 100 + Math.random() * 40;
                const lightness = 10 + Math.random() * 15;
                
                ctx.strokeStyle = `hsl(${hue}, 40%, ${lightness}%)`;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + (Math.random() - 0.5) * 5, y - height);
                ctx.stroke();
            }
            
            return new THREE.CanvasTexture(canvas);
        }

        function createFlowerTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            
            // Petals
            const colors = ['#f4a5c0', '#e8dff0', '#fae588'];
            ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
            
            for (let i = 0; i < 5; i++) {
                const angle = (i / 5) * Math.PI * 2;
                const x = 16 + Math.cos(angle) * 8;
                const y = 16 + Math.sin(angle) * 8;
                ctx.beginPath();
                ctx.ellipse(x, y, 5, 3, angle, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Center
            ctx.fillStyle = '#f4d35e';
            ctx.beginPath();
            ctx.arc(16, 16, 4, 0, Math.PI * 2);
            ctx.fill();
            
            return new THREE.CanvasTexture(canvas);
        }

        // =========================================================================
        // GARDEN ENVIRONMENT
        // =========================================================================
        
        // Ground
        const groundGeo = new THREE.PlaneGeometry(100, 100);
        const groundMat = new THREE.MeshStandardMaterial({
            color: 0x0d1a12,
            roughness: 1,
            metalness: 0
        });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -1;
        scene.add(ground);

        // Grass particles
        const grassCount = 3000;
        const grassGeo = new THREE.BufferGeometry();
        const grassPos = new Float32Array(grassCount * 3);
        const grassColors = new Float32Array(grassCount * 3);

        for (let i = 0; i < grassCount; i++) {
            const i3 = i * 3;
            const radius = Math.sqrt(Math.random()) * 30;
            const angle = Math.random() * Math.PI * 2;
            
            grassPos[i3] = Math.cos(angle) * radius;
            grassPos[i3 + 1] = -0.9 + Math.random() * 0.3;
            grassPos[i3 + 2] = Math.sin(angle) * radius - 5;
            
            const green = 0.15 + Math.random() * 0.15;
            grassColors[i3] = green * 0.5;
            grassColors[i3 + 1] = green;
            grassColors[i3 + 2] = green * 0.3;
        }

        grassGeo.setAttribute('position', new THREE.BufferAttribute(grassPos, 3));
        grassGeo.setAttribute('color', new THREE.BufferAttribute(grassColors, 3));

        const grassMat = new THREE.PointsMaterial({
            size: 0.15,
            vertexColors: true,
            transparent: true,
            opacity: 0.8
        });
        const grass = new THREE.Points(grassGeo, grassMat);
        scene.add(grass);

        // Flowers scattered
        const flowerTex = createFlowerTexture();
        const flowers = [];

        for (let i = 0; i < 50; i++) {
            const mat = new THREE.SpriteMaterial({
                map: createFlowerTexture(),
                transparent: true,
                opacity: 0.7
            });
            const sprite = new THREE.Sprite(mat);
            
            const radius = 3 + Math.random() * 15;
            const angle = Math.random() * Math.PI * 2;
            
            sprite.position.set(
                Math.cos(angle) * radius,
                -0.7 + Math.random() * 0.2,
                Math.sin(angle) * radius - 5
            );
            sprite.scale.set(0.3 + Math.random() * 0.2, 0.3 + Math.random() * 0.2, 1);
            
            scene.add(sprite);
            flowers.push(sprite);
        }

        // Background trees (silhouettes)
        const treeTex = createGlowTexture('rgba(15, 25, 20, 1)');
        for (let i = 0; i < 15; i++) {
            const mat = new THREE.SpriteMaterial({
                map: treeTex,
                transparent: true,
                opacity: 0.8
            });
            const tree = new THREE.Sprite(mat);
            
            const angle = (i / 15) * Math.PI * 2;
            const radius = 25 + Math.random() * 10;
            
            tree.position.set(
                Math.cos(angle) * radius,
                3 + Math.random() * 4,
                Math.sin(angle) * radius - 10
            );
            tree.scale.set(8 + Math.random() * 6, 12 + Math.random() * 8, 1);
            
            scene.add(tree);
        }

        // Stars in sky
        const starGeo = new THREE.BufferGeometry();
        const starCount = 300;
        const starPos = new Float32Array(starCount * 3);

        for (let i = 0; i < starCount; i++) {
            const i3 = i * 3;
            starPos[i3] = (Math.random() - 0.5) * 100;
            starPos[i3 + 1] = 10 + Math.random() * 30;
            starPos[i3 + 2] = -20 - Math.random() * 30;
        }

        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({
            color: 0xffffee,
            size: 0.1,
            transparent: true,
            opacity: 0.6
        });
        const starField = new THREE.Points(starGeo, starMat);
        scene.add(starField);

        // =========================================================================
        // FIREFLIES
        // =========================================================================
        
        const fireflies = [];
        const fireflyTex = createGlowTexture('rgba(244, 211, 94, 1)');
        const collectibleTex = createGlowTexture('rgba(255, 230, 150, 1)');

        // Ambient fireflies (non-collectible, background)
        for (let i = 0; i < 40; i++) {
            const mat = new THREE.SpriteMaterial({
                map: fireflyTex,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            const sprite = new THREE.Sprite(mat);
            
            sprite.position.set(
                (Math.random() - 0.5) * 30,
                Math.random() * 5,
                (Math.random() - 0.5) * 20 - 5
            );
            sprite.scale.set(0.3, 0.3, 1);
            
            sprite.userData = {
                basePos: sprite.position.clone(),
                phase: Math.random() * Math.PI * 2,
                speed: 0.5 + Math.random() * 0.5,
                amplitude: 0.5 + Math.random() * 1,
                isCollectible: false
            };
            
            // Point light for ambient fireflies
            const light = new THREE.PointLight(0xf4d35e, 0.15, 3);
            sprite.add(light);
            
            scene.add(sprite);
            fireflies.push(sprite);
        }

        // Collectible fireflies (larger, brighter)
        for (let i = 0; i < state.maxScore; i++) {
            const mat = new THREE.SpriteMaterial({
                map: collectibleTex,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            const sprite = new THREE.Sprite(mat);
            
            // Spread them around the garden
            const angle = (i / state.maxScore) * Math.PI * 2 + Math.random() * 0.5;
            const radius = 4 + Math.random() * 8;
            
            sprite.position.set(
                Math.cos(angle) * radius,
                0.5 + Math.random() * 3,
                Math.sin(angle) * radius - 5
            );
            sprite.scale.set(0.8, 0.8, 1);
            
            sprite.userData = {
                index: i,
                basePos: sprite.position.clone(),
                phase: Math.random() * Math.PI * 2,
                speed: 0.3 + Math.random() * 0.3,
                amplitude: 0.8 + Math.random() * 0.5,
                isCollectible: true,
                active: true
            };
            
            // Brighter light for collectibles
            const light = new THREE.PointLight(0xfae588, 0.5, 5);
            sprite.add(light);
            
            scene.add(sprite);
            fireflies.push(sprite);
        }

        // =========================================================================
        // AUDIO
        // =========================================================================
        
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.master = null;
            }

            init() {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain();
                this.master.gain.value = 0.3;
                this.master.connect(this.ctx.destination);

                this.playAmbience();
                this.playMelody();
            }

            playAmbience() {
                // Night crickets simulation
                const createCricket = (freq, interval) => {
                    setInterval(() => {
                        if (this.ctx.state !== 'running' || state.isMuted) return;
                        
                        const osc = this.ctx.createOscillator();
                        osc.type = 'sine';
                        osc.frequency.value = freq + Math.random() * 100;
                        
                        const gain = this.ctx.createGain();
                        gain.gain.setValueAtTime(0, this.ctx.currentTime);
                        gain.gain.linearRampToValueAtTime(0.015, this.ctx.currentTime + 0.01);
                        gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.05);
                        
                        osc.connect(gain);
                        gain.connect(this.master);
                        osc.start();
                        osc.stop(this.ctx.currentTime + 0.05);
                    }, interval + Math.random() * interval);
                };

                createCricket(4000, 200);
                createCricket(4500, 300);
                createCricket(5000, 250);
            }

            playMelody() {
                // Gentle pentatonic melody
                const scale = [392, 440, 523.25, 587.33, 659.25]; // G4 pentatonic
                
                const playNote = () => {
                    if (state.dialogueOpen) {
                        setTimeout(playNote, 4000);
                        return;
                    }

                    const osc = this.ctx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = scale[Math.floor(Math.random() * scale.length)];

                    const gain = this.ctx.createGain();
                    gain.gain.setValueAtTime(0, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.05, this.ctx.currentTime + 0.5);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 4);

                    osc.connect(gain);
                    gain.connect(this.master);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 4);

                    setTimeout(playNote, 3000 + Math.random() * 5000);
                };

                setTimeout(playNote, 2000);
            }

            playCollect() {
                if (!this.ctx) return;

                // Magical chime
                const notes = [659.25, 783.99, 987.77, 1174.66];
                notes.forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = freq;

                    const gain = this.ctx.createGain();
                    const startTime = this.ctx.currentTime + i * 0.08;
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(0.12, startTime + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.8);

                    osc.connect(gain);
                    gain.connect(this.master);
                    osc.start(startTime);
                    osc.stop(startTime + 0.8);
                });
            }

            toggleMute() {
                state.isMuted = !state.isMuted;
                if (this.master) {
                    this.master.gain.value = state.isMuted ? 0 : 0.3;
                }
                return state.isMuted;
            }
        }

        const audio = new AudioEngine();

        // =========================================================================
        // INPUT
        // =========================================================================
        
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        function onPointerDown(clientX, clientY) {
            if (!state.isPlaying || state.dialogueOpen) return;

            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // Check collectible fireflies
            const collectibles = fireflies.filter(f => f.userData.isCollectible && f.userData.active);
            const intersects = raycaster.intersectObjects(collectibles);

            if (intersects.length > 0) {
                const firefly = intersects[0].object;
                collectFirefly(firefly);
            }
        }

        document.addEventListener('click', (e) => {
            onPointerDown(e.clientX, e.clientY);
        });

        document.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            onPointerDown(touch.clientX, touch.clientY);
        }, { passive: true });

        // Camera follows mouse slightly
        document.addEventListener('mousemove', (e) => {
            state.mouseX = (e.clientX / window.innerWidth) * 2 - 1;
            state.mouseY = (e.clientY / window.innerHeight) * 2 - 1;
        });

        document.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            state.mouseX = (touch.clientX / window.innerWidth) * 2 - 1;
            state.mouseY = (touch.clientY / window.innerHeight) * 2 - 1;
        }, { passive: true });

        // =========================================================================
        // UI
        // =========================================================================
        
        const ui = {
            countdownScreen: document.getElementById('countdown-screen'),
            intro: document.getElementById('intro'),
            hud: document.getElementById('hud'),
            progressText: document.getElementById('progressText'),
            dialogue: document.getElementById('dialogue'),
            dialogueIcon: document.getElementById('dialogueIcon'),
            dialogueLabel: document.getElementById('dialogueLabel'),
            dialogueText: document.getElementById('dialogueText'),
            btnContinue: document.getElementById('btnContinue'),
            ending: document.getElementById('ending'),
            btnStart: document.getElementById('btnStart'),
            btnSound: document.getElementById('btnSound'),
            iconSound: document.getElementById('iconSound'),
            controlHint: document.getElementById('controlHint')
        };

        function updateProgress() {
            ui.progressText.textContent = `${state.score} / ${state.maxScore}`;
        }

        let typeTimer = null;
        function showDialogue(messageObj) {
            if (typeTimer) clearTimeout(typeTimer);
            
            state.dialogueOpen = true;
            ui.dialogue.classList.add('visible');
            ui.dialogueText.innerHTML = '';
            ui.btnContinue.classList.remove('visible');

            if (messageObj.type === 'doa') {
                ui.dialogue.classList.add('is-doa');
                ui.dialogueIcon.textContent = 'ðŸ¤²';
                ui.dialogueLabel.textContent = 'Doa dari Rizal:';
            } else {
                ui.dialogue.classList.remove('is-doa');
                ui.dialogueIcon.textContent = 'âœ¦';
                ui.dialogueLabel.textContent = 'Rizal berbisik:';
            }

            let i = 0;
            const text = messageObj.text;
            const typeChar = () => {
                if (i < text.length) {
                    ui.dialogueText.innerHTML += text.charAt(i);
                    i++;
                    typeTimer = setTimeout(typeChar, 28);
                } else {
                    ui.btnContinue.classList.add('visible');
                }
            };
            typeChar();
        }

        function hideDialogue() {
            if (typeTimer) clearTimeout(typeTimer);
            ui.dialogue.classList.remove('visible');
            ui.dialogue.classList.remove('is-doa');
            ui.btnContinue.classList.remove('visible');
            state.dialogueOpen = false;
        }

        // =========================================================================
        // GAME LOGIC
        // =========================================================================
        
        function collectFirefly(firefly) {
            firefly.userData.active = false;
            
            audio.playCollect();
            createCollectEffect(firefly.position.clone());
            
            // Fade out
            const fadeOut = () => {
                firefly.material.opacity -= 0.05;
                firefly.scale.multiplyScalar(1.05);
                if (firefly.material.opacity > 0) {
                    requestAnimationFrame(fadeOut);
                } else {
                    firefly.visible = false;
                }
            };
            fadeOut();

            state.score++;
            updateProgress();

            const msg = messages[state.score - 1];
            if (msg) showDialogue(msg);

            if (state.score >= state.maxScore) {
                setTimeout(showEnding, 10000);
            }
        }

        function createCollectEffect(pos) {
            const count = 15;
            for (let i = 0; i < count; i++) {
                const mat = new THREE.SpriteMaterial({
                    map: fireflyTex,
                    transparent: true,
                    blending: THREE.AdditiveBlending
                });
                const particle = new THREE.Sprite(mat);
                particle.position.copy(pos);
                particle.scale.set(0.4, 0.4, 1);
                scene.add(particle);

                const angle = (i / count) * Math.PI * 2;
                const speed = 0.02 + Math.random() * 0.03;
                const vel = {
                    x: Math.cos(angle) * speed,
                    y: Math.sin(angle) * speed + 0.02,
                    z: (Math.random() - 0.5) * speed
                };

                const animate = () => {
                    particle.position.x += vel.x;
                    particle.position.y += vel.y;
                    particle.position.z += vel.z;
                    vel.y -= 0.001;
                    particle.material.opacity -= 0.015;
                    particle.scale.multiplyScalar(0.98);

                    if (particle.material.opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        scene.remove(particle);
                    }
                };
                animate();
            }
        }

        function showEnding() {
            state.isPlaying = false;
            ui.hud.classList.remove('visible');
            ui.dialogue.classList.remove('visible');
            ui.ending.classList.add('active');
        }

        // =========================================================================
        // MAIN LOOP
        // =========================================================================
        
        let time = 0;

        function update() {
            time += 0.016;

            // Animate fireflies
            fireflies.forEach(firefly => {
                if (!firefly.userData.active && firefly.userData.isCollectible) return;
                
                const data = firefly.userData;
                const t = time * data.speed + data.phase;
                
                // Floating motion
                firefly.position.x = data.basePos.x + Math.sin(t) * data.amplitude;
                firefly.position.y = data.basePos.y + Math.sin(t * 1.3) * data.amplitude * 0.5;
                firefly.position.z = data.basePos.z + Math.cos(t * 0.7) * data.amplitude * 0.5;
                
                // Pulsing glow
                const pulse = 0.7 + Math.sin(t * 3) * 0.3;
                firefly.material.opacity = pulse * (data.isCollectible ? 1 : 0.6);
                
                // Update light intensity
                if (firefly.children[0]) {
                    firefly.children[0].intensity = pulse * (data.isCollectible ? 0.5 : 0.15);
                }
            });

            // Gentle camera movement
            if (state.isPlaying && !state.dialogueOpen) {
                camera.position.x += (state.mouseX * 2 - camera.position.x) * 0.02;
                camera.position.y += (2 + state.mouseY * 0.5 - camera.position.y) * 0.02;
                camera.lookAt(0, 1, -5);
            }

            // Twinkle stars
            const starOpacity = 0.4 + Math.sin(time * 0.5) * 0.2;
            starField.material.opacity = starOpacity;

            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        // =========================================================================
        // EVENT LISTENERS
        // =========================================================================
        
        ui.btnStart.addEventListener('click', () => {
            ui.intro.style.opacity = '0';
            ui.intro.style.pointerEvents = 'none';
            setTimeout(() => {
                ui.intro.style.display = 'none';
            }, 1200);

            ui.hud.classList.add('visible');
            
            setTimeout(() => {
                ui.controlHint.classList.add('hidden');
            }, 5000);

            audio.init();
            state.isPlaying = true;
        });

        ui.dialogue.addEventListener('click', () => {
            if (ui.btnContinue.classList.contains('visible')) {
                hideDialogue();
            }
        });

        ui.btnSound.addEventListener('click', () => {
            const muted = audio.toggleMute();
            ui.iconSound.innerHTML = muted 
                ? '<path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>'
                : '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>';
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // =========================================================================
        // INIT
        // =========================================================================
        
        startCountdown();
        update();

    </script>
</body>
</html>
