<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Untuk Hani Febiana - From Rizal</title>
    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Montserrat:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <style>
        /* --- ROMANTIC THEME STYLES --- */
        :root {
            --primary: #ff9a9e;
            --secondary: #fecfef;
            --accent: #fff1eb;
            --text-gold: #FFD700;
            --glass: rgba(45, 10, 40, 0.5);
            --glass-border: rgba(255, 200, 200, 0.2);
            --deep-purple: #2c0e37;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: 'Montserrat', sans-serif;
            color: white;
            width: 100vw; height: 100vh;
            touch-action: none; /* Kunci scroll di HP */
        }

        #canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background: linear-gradient(to bottom, #2c3e50, #bdc3c7); /* Fallback */
        }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .pointer-events-auto { pointer-events: auto; }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(60, 20, 60, 0.8), rgba(10, 5, 20, 0.95));
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            transition: opacity 1.5s ease;
            padding: 20px;
        }

        .title-box h1 {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            background: linear-gradient(to right, #ffecd2 0%, #fcb69f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 150, 150, 0.3);
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .title-box h2 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            font-size: clamp(1rem, 4vw, 1.5rem);
            color: #ffc3a0;
            letter-spacing: 3px;
            margin-bottom: 2rem;
            text-transform: uppercase;
        }

        .heart-beat {
            color: #ff6b6b;
            animation: heartbeat 1.5s infinite;
            display: inline-block;
        }

        .btn-start {
            padding: 18px 50px;
            font-size: 1.1rem;
            font-weight: 500;
            color: white;
            background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(255, 100, 100, 0.3);
            margin-top: 20px;
        }

        .btn-start:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 100, 100, 0.5);
        }

        /* HUD */
        #hud {
            padding: 25px;
            display: flex; justify-content: space-between; align-items: flex-start;
            opacity: 0; transition: opacity 1s;
        }

        .hud-item {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex; align-items: center; gap: 10px;
            backdrop-filter: blur(5px);
            color: #fff;
        }

        /* DIALOGUE BOX - Love Letter Style */
        #dialogue-container {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 650px;
            background: rgba(20, 10, 30, 0.85);
            border: 1px solid rgba(255, 180, 180, 0.3);
            border-radius: 20px;
            padding: 30px;
            display: none;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            border-left: 5px solid #ff9a9e;
        }

        .speaker-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            color: #ff9a9e;
            margin-bottom: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .dialogue-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            line-height: 1.6;
            color: #fff1eb;
            font-style: italic;
        }

        .next-arrow {
            position: absolute; bottom: 20px; right: 25px;
            color: #ff9a9e;
            animation: float 2s infinite ease-in-out;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* END SCREEN */
        #end-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #2c0e37, #662d60);
            z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 2s ease;
            padding: 20px;
        }

        .wish-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            max-width: 600px;
            transform: translateY(50px);
            transition: transform 1s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        #end-screen.active { opacity: 1; pointer-events: auto; }
        #end-screen.active .wish-card { transform: translateY(0); }

        /* KEYFRAMES */
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* VIRTUAL JOYSTICK HINT */
        .control-hint {
            position: absolute; bottom: 30px; width: 100%;
            text-align: center; font-size: 0.8rem; color: rgba(255,255,255,0.6);
            animation: fadeOut 5s forwards 3s;
        }
        @keyframes fadeOut { to { opacity: 0; } }

    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <!-- Start -->
        <div id="start-screen" class="pointer-events-auto">
            <div class="title-box">
                <h1>Untuk Hani Febiana</h1>
                <h2><span style="font-size: 0.8em; opacity: 0.8;">From:</span> Muhammad Rizal Setiawan</h2>
            </div>
            <div style="margin-bottom: 30px; font-size: 2rem;">
                <i class="fas fa-heart heart-beat"></i>
            </div>
            <p style="margin-bottom: 40px; color: #ffdede; max-width: 500px; line-height: 1.8; font-family: 'Playfair Display', serif; font-style: italic;">
                "Terbanglah bersamaku sejenak.<br>Ada beberapa bintang harapan yang ingin kurangkai<br>menjadi sebuah doa untukmu."
            </p>
            <button class="btn-start" id="btn-start">Mulai Perjalanan</button>
        </div>

        <!-- HUD -->
        <div id="hud">
            <div class="hud-item">
                <i class="fas fa-heart" style="color: #ff9a9e;"></i>
                <span id="score-text" style="font-family: 'Montserrat'; font-weight: 600;">0 / 7</span>
            </div>
            
            <div class="hud-item pointer-events-auto" style="cursor: pointer;" id="btn-mute">
                <i class="fas fa-volume-up" id="icon-vol"></i>
            </div>
        </div>

        <!-- Dialogue -->
        <div id="dialogue-container" class="pointer-events-auto">
            <div class="speaker-name">Rizal Berkata:</div>
            <div class="dialogue-text" id="dialogue-text"></div>
            <div class="next-arrow" id="btn-next-dialogue"><i class="fas fa-chevron-right"></i></div>
        </div>

        <!-- End -->
        <div id="end-screen">
            <div class="wish-card">
                <i class="fas fa-infinity" style="font-size: 3rem; color: #ff9a9e; margin-bottom: 20px;"></i>
                <h1 style="font-family: 'Playfair Display'; font-size: 2.5rem; margin-bottom: 10px; color: #fff;">Selamat Ulang Tahun</h1>
                <h2 style="font-family: 'Montserrat'; font-size: 1.2rem; color: #ffc3a0; margin-bottom: 30px;">Hani Febiana, Sayangku</h2>
                
                <p style="line-height: 1.8; color: #eee; font-size: 1.1rem; margin-bottom: 30px; font-family: 'Playfair Display', serif; font-style: italic;">
                    "Terima kasih telah menjadi bagian terindah dalam hidupku.<br>
                    Semoga hari-harimu selalu dipenuhi warna seindah langit senja ini.<br>
                    Aku mencintaimu, hari ini dan seterusnya."
                </p>
                <div style="font-size: 0.9rem; color: #aaa; margin-top: 20px;">- Rizal -</div>
                <button class="btn-start" onclick="location.reload()" style="margin-top: 30px; font-size: 0.9rem;">Ulangi Kenangan</button>
            </div>
        </div>

        <div class="control-hint" id="hint-text">Sentuh & Tahan Layar untuk Mengarahkan Hati</div>
    </div>

    <script>
        /**
         * =========================================================================
         * ENGINE CORE: THREE.JS SETUP & UTILITIES
         * =========================================================================
         */
        
        const MathUtils = {
            rand: (min, max) => Math.random() * (max - min) + min,
            lerp: (start, end, t) => start * (1 - t) + end * t,
            clamp: (val, min, max) => Math.max(min, Math.min(max, val))
        };

        const state = {
            isRunning: false,
            score: 0,
            maxScore: 7,
            speed: 0,
            baseSpeed: 0.6, // Slightly slower for romantic vibe
            mouseX: 0,
            mouseY: 0,
            targetX: 0,
            targetY: 0,
            planePos: { x: 0, y: 0 },
            isDialogueOpen: false
        };

        // --- RIZAL'S MESSAGES FOR HANI ---
        const stories = [
            "Hani... Setiap kali aku melihatmu, duniaku terasa lebih berwarna. Kamu adalah keajaiban terindah yang pernah hadir dalam hidupku.",
            "Aku selalu kagum dengan caramu tersenyum. Senyummu punya kekuatan untuk membuat hari terberatku menjadi ringan. Terima kasih sudah selalu ada.",
            "Bersama kamu, aku belajar arti sabar dan tulus mencintai. Kamu mengajarkanku bahwa cinta bukan hanya tentang kata-kata, tapi tentang kehadiran.",
            "Aku tidak butuh langit yang sempurna, karena langitku sudah sempurna dengan adanya kamu di dalamnya. Kamu adalah bintang paling terang di hidupku.",
            "Kalau ada satu hal yang ingin aku lakukan seumur hidupku, itu adalah membuatmu bahagia. Karena kebahagiaanmu adalah kebahagiaanku juga.",
            "Terima kasih sudah menerima aku apa adanya, dengan segala kekurangan dan kelebihanku. Di matamu, aku merasa menjadi versi terbaik dari diriku.",
            "Hani, aku tidak bisa menjanjikan segalanya akan selalu mudah. Tapi aku berjanji akan selalu ada di sampingmu, dalam suka maupun duka. Aku sayang kamu, selamanya."
        ];

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        // Romantic Purple Fog
        scene.fog = new THREE.FogExp2(0x2c0e37, 0.0025); 

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 4, 15);

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- LIGHTING ---
        const ambientLight = new THREE.AmbientLight(0xffccff, 0.5); // Pinkish ambient
        scene.add(ambientLight);

        const sunLight = new THREE.DirectionalLight(0xffaa00, 1.2); // Golden hour sun
        sunLight.position.set(20, 50, -100);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // --- ASSET GENERATORS ---
        
        // 1. Heart Texture (Canvas)
        function createHeartTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            
            ctx.translate(64, 64);
            ctx.scale(2.5, 2.5);
            ctx.translate(-64, -64);

            ctx.beginPath();
            ctx.moveTo(75, 40);
            ctx.bezierCurveTo(75, 37, 70, 25, 50, 25);
            ctx.bezierCurveTo(20, 25, 20, 62.5, 20, 62.5);
            ctx.bezierCurveTo(20, 80, 40, 102, 75, 120);
            ctx.bezierCurveTo(110, 102, 130, 80, 130, 62.5);
            ctx.bezierCurveTo(130, 62.5, 130, 25, 100, 25);
            ctx.bezierCurveTo(85, 25, 75, 37, 75, 40);
            ctx.fillStyle = color;
            ctx.fill();

            // Glow
            ctx.globalCompositeOperation = 'destination-over';
            const grad = ctx.createRadialGradient(75, 75, 10, 75, 75, 60);
            grad.addColorStop(0, 'rgba(255,255,255,0.8)');
            grad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,150,150);

            return new THREE.CanvasTexture(canvas);
        }

        // 2. Sunset Cloud Texture
        function createCloudTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(64,64,0, 64,64,64);
            grad.addColorStop(0, 'rgba(255, 200, 220, 0.6)'); // Pinkish
            grad.addColorStop(0.5, 'rgba(200, 150, 200, 0.2)'); // Purpleish
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,128,128);
            return new THREE.CanvasTexture(canvas);
        }

        // 3. Glowing Orb (The "Star")
        function createOrbTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(32,32,0, 32,32,32);
            grad.addColorStop(0, '#fff');
            grad.addColorStop(0.4, '#ff9a9e');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,64,64);
            return new THREE.CanvasTexture(canvas);
        }

        // --- GAME OBJECTS ---

        // 1. THE PAPER PLANE (Glowing)
        let plane;
        function createPlane() {
            const geometry = new THREE.BufferGeometry();
            const vertices = new Float32Array([
                0, 0, 3,    -1.5, 0.5, -1,   0, -0.5, -1, // Left Wing
                0, 0, 3,    0, -0.5, -1,     1.5, 0.5, -1, // Right Wing
                0, 0, 3,    0, 0.5, -1,      0, 0, -1      // Spine (for thickness visual)
            ]);
            geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            geometry.computeVertexNormals();

            const material = new THREE.MeshStandardMaterial({ 
                color: 0xffffff, 
                emissive: 0xffaaaa,
                emissiveIntensity: 0.3,
                roughness: 0.3, 
                metalness: 0.5,
                side: THREE.DoubleSide
            });

            plane = new THREE.Mesh(geometry, material);
            scene.add(plane);

            // Add a point light to the plane so it illuminates clouds
            const planeLight = new THREE.PointLight(0xff9a9e, 1, 20);
            plane.add(planeLight);
        }

        // 2. ROMANTIC CLOUDS
        const clouds = [];
        const cloudTex = createCloudTexture();
        
        function spawnCloud(zStart) {
            const group = new THREE.Group();
            const puffCount = 3 + Math.floor(Math.random() * 3);
            const mat = new THREE.SpriteMaterial({ map: cloudTex, transparent: true, opacity: 0.6, depthWrite: false });
            
            for(let i=0; i<puffCount; i++) {
                const sprite = new THREE.Sprite(mat);
                const scale = 10 + Math.random() * 15;
                sprite.scale.set(scale, scale, 1);
                sprite.position.set(
                    Math.random() * 10 - 5,
                    Math.random() * 5 - 2.5,
                    Math.random() * 5 - 2.5
                );
                group.add(sprite);
            }

            const angle = Math.random() * Math.PI * 2;
            const radius = 30 + Math.random() * 40; 
            group.position.x = Math.cos(angle) * radius;
            group.position.y = Math.sin(angle) * radius;
            group.position.z = zStart;

            // Variasi warna ungu/pink
            const hueShift = Math.random() * 0.1;
            group.children.forEach(s => s.material.color.setHSL(0.8 + hueShift, 0.7, 0.8));

            scene.add(group);
            clouds.push(group);
        }

        for(let i=0; i<40; i++) spawnCloud(-i * 15);

        // 3. COLLECTIBLE ORBS
        const stars = [];
        const orbTex = createOrbTexture();
        
        function spawnStar(index) {
            const mat = new THREE.SpriteMaterial({ map: orbTex, blending: THREE.AdditiveBlending });
            const sprite = new THREE.Sprite(mat);
            sprite.scale.set(4, 4, 1);

            const zPos = -60 - (index * 140); // Further distance for relaxed pace
            const xPos = Math.sin(index * 0.8) * 20;
            const yPos = Math.cos(index * 0.6) * 12;
            
            sprite.position.set(xPos, yPos, zPos);
            sprite.userData = { id: index, active: true };
            
            scene.add(sprite);
            stars.push(sprite);
        }

        for(let i=0; i<state.maxScore; i++) spawnStar(i);

        // 4. HEART PARTICLES (Atmosphere)
        const heartTex = createHeartTexture('#ffc0cb');
        const particleGeo = new THREE.BufferGeometry();
        const particleCount = 200;
        const pPos = new Float32Array(particleCount * 3);
        
        for(let i=0; i<particleCount*3; i+=3) {
            pPos[i] = (Math.random() - 0.5) * 100;
            pPos[i+1] = (Math.random() - 0.5) * 60;
            pPos[i+2] = -Math.random() * 100;
        }
        particleGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const particleMat = new THREE.PointsMaterial({ 
            map: heartTex, 
            size: 0.8, 
            transparent: true, 
            opacity: 0.4, 
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });
        const particleSystem = new THREE.Points(particleGeo, particleMat);
        scene.add(particleSystem);

        /**
         * =========================================================================
         * INPUT & CONTROLS (Improved for Mobile)
         * =========================================================================
         */

        // Using a "Virtual Joystick" logic without visual UI
        // We track the delta of movement from the touch start
        let touchStartX = 0;
        let touchStartY = 0;
        
        function handleInput(normalizedX, normalizedY) {
            state.targetX = normalizedX * 25; // Max X range
            state.targetY = normalizedY * 15; // Max Y range
        }

        document.addEventListener('mousemove', e => {
            const nX = (e.clientX / window.innerWidth) * 2 - 1;
            const nY = -(e.clientY / window.innerHeight) * 2 + 1;
            handleInput(nX, nY);
        });

        document.addEventListener('touchstart', e => {
            // e.preventDefault();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: false });

        document.addEventListener('touchmove', e => {
            e.preventDefault(); // Prevent scroll
            const touch = e.touches[0];
            
            // Map directly to screen position for "Follow Finger" feeling
            // This is often more intuitive for casual users than relative joystick
            const nX = (touch.clientX / window.innerWidth) * 2 - 1;
            const nY = -(touch.clientY / window.innerHeight) * 2 + 1;
            
            // Add a slight offset so finger doesn't cover the plane
            handleInput(nX, nY + 0.3);
        }, { passive: false });

        /**
         * =========================================================================
         * AUDIO (Romantic Melodic Procedural)
         * =========================================================================
         */
        class AudioSynth {
            constructor() {
                this.ctx = null;
                this.master = null;
                this.isMuted = false;
            }

            init() {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain();
                this.master.gain.value = 0.3;
                this.master.connect(this.ctx.destination);
                
                this.playPad();
                this.playMelody();
            }

            playPad() {
                // Warm, swelling pad
                const osc = this.ctx.createOscillator();
                osc.type = 'triangle';
                osc.frequency.value = 130.81; // C3
                
                const gain = this.ctx.createGain();
                gain.gain.value = 0.1;
                
                // Lowpass filter to make it soft
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 400;

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.master);
                osc.start();

                // LFO for movement
                setInterval(() => {
                    if(this.ctx.state === 'running') {
                        filter.frequency.rampToValueAtTime(400 + Math.sin(this.ctx.currentTime) * 100, this.ctx.currentTime + 2);
                    }
                }, 2000);
            }

            playMelody() {
                // C Major Pentatonic: C, D, E, G, A
                const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25];
                
                const playNote = () => {
                    if(state.isDialogueOpen) {
                         setTimeout(playNote, 1000); // Pause melody during dialogue mostly
                         return;
                    }

                    const osc = this.ctx.createOscillator();
                    osc.type = 'sine';
                    const note = scale[Math.floor(Math.random() * scale.length)];
                    osc.frequency.value = note;

                    const gain = this.ctx.createGain();
                    gain.gain.setValueAtTime(0, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.1, this.ctx.currentTime + 0.5); // Slow attack
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 3); // Long release

                    osc.connect(gain);
                    gain.connect(this.master);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 3.1);

                    setTimeout(playNote, Math.random() * 2000 + 1500); // Slow tempo
                };
                playNote();
            }

            playCollect() {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1046.5, this.ctx.currentTime + 0.3); // High sparkle
                
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                
                osc.connect(gain);
                gain.connect(this.master);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                if(this.master) this.master.gain.value = this.isMuted ? 0 : 0.3;
                return this.isMuted;
            }
        }
        const audioSys = new AudioSynth();

        /**
         * =========================================================================
         * GAME LOOP
         * =========================================================================
         */

        createPlane();

        function update() {
            if(!state.isRunning) {
                // Idle Rotation
                if(plane) {
                    plane.rotation.z = Math.sin(performance.now() * 0.001) * 0.1;
                    plane.rotation.y += 0.005;
                }
                renderer.render(scene, camera);
                requestAnimationFrame(update);
                return;
            }

            // 1. Plane Movement (Smoothed with Lerp)
            // Use a higher lerp factor for mobile responsiveness, but maintain weight
            const lerpFactor = 0.08; 
            
            plane.position.x = MathUtils.lerp(plane.position.x, state.targetX, lerpFactor);
            plane.position.y = MathUtils.lerp(plane.position.y, state.targetY, lerpFactor);
            plane.rotation.y = 0; // Reset from idle

            // Banking Logic (Tilt when moving)
            const bankAngle = -(plane.position.x - state.targetX) * 0.1; // Calculate diff
            plane.rotation.z = MathUtils.lerp(plane.rotation.z, bankAngle, 0.1);
            
            // Pitch Logic (Tilt up/down)
            const pitchAngle = -(plane.position.y - state.targetY) * 0.05;
            plane.rotation.x = MathUtils.lerp(plane.rotation.x, pitchAngle, 0.1);

            // 2. Camera Follow (Cinematic Lag)
            camera.position.x = MathUtils.lerp(camera.position.x, plane.position.x * 0.5, 0.05);
            camera.position.y = MathUtils.lerp(camera.position.y, plane.position.y * 0.5 + 4, 0.05);

            // 3. Environment Movement
            state.speed = state.isDialogueOpen ? MathUtils.lerp(state.speed, 0.1, 0.05) : state.baseSpeed;

            // Clouds
            clouds.forEach(c => {
                c.position.z += state.speed;
                if(c.position.z > 20) {
                    c.position.z = -400;
                    c.position.x = (Math.random() - 0.5) * 80;
                    c.position.y = (Math.random() - 0.5) * 40;
                }
            });

            // Stars/Orbs
            stars.forEach(s => {
                if(s.userData.active) {
                    s.position.z += state.speed;
                    // Collision
                    if(plane.position.distanceTo(s.position) < 5) {
                        collectStar(s);
                    }
                    // Respawn if missed (to ensure she gets all messages)
                    if(s.position.z > 10) {
                        s.position.z = -200; // Try again far back
                        s.position.x = MathUtils.lerp(s.position.x, plane.position.x, 0.5); // Closer to player lane
                    }
                }
            });

            // Particles
            const pPositions = particleSystem.geometry.attributes.position.array;
            for(let i=2; i<pPositions.length; i+=3) {
                pPositions[i] += state.speed * 1.5;
                if(pPositions[i] > 20) pPositions[i] = -100;
            }
            particleSystem.geometry.attributes.position.needsUpdate = true;

            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        function collectStar(star) {
            star.userData.active = false;
            star.visible = false;
            
            audioSys.playCollect();
            createHeartExplosion(star.position);

            state.score++;
            updateHUD();

            const text = stories[state.score - 1];
            if(text) showDialogue(text);

            if(state.score >= state.maxScore) {
                setTimeout(endGame, 5000);
            }
        }

        function createHeartExplosion(pos) {
            const mat = new THREE.SpriteMaterial({ map: heartTex, color: 0xff69b4, transparent: true });
            const count = 10;
            for(let i=0; i<count; i++) {
                const s = new THREE.Sprite(mat);
                s.position.copy(pos);
                s.scale.set(2,2,1);
                scene.add(s);
                
                const vel = new THREE.Vector3(
                    (Math.random()-0.5)*0.5,
                    (Math.random()-0.5)*0.5,
                    (Math.random()-0.5)*0.5
                );

                const anim = () => {
                    s.position.add(vel);
                    s.material.opacity -= 0.02;
                    if(s.material.opacity > 0) requestAnimationFrame(anim);
                    else scene.remove(s);
                };
                anim();
            }
        }

        // --- UI LOGIC ---
        const ui = {
            startScreen: document.getElementById('start-screen'),
            hud: document.getElementById('hud'),
            scoreText: document.getElementById('score-text'),
            dialogueBox: document.getElementById('dialogue-container'),
            dialogueText: document.getElementById('dialogue-text'),
            endScreen: document.getElementById('end-screen'),
            startBtn: document.getElementById('btn-start'),
            nextBtn: document.getElementById('btn-next-dialogue'),
            muteBtn: document.getElementById('btn-mute')
        };

        ui.startBtn.addEventListener('click', () => {
            ui.startScreen.style.opacity = '0';
            setTimeout(() => ui.startScreen.style.display = 'none', 1500);
            
            ui.hud.style.opacity = '1';
            audioSys.init();
            state.isRunning = true;
            update();
        });

        ui.muteBtn.addEventListener('click', () => {
            const muted = audioSys.toggleMute();
            ui.muteBtn.innerHTML = muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        });

        function updateHUD() {
            ui.scoreText.innerText = `${state.score} / ${state.maxScore}`;
        }

        let typeTimeout;
        function showDialogue(text) {
            if(typeTimeout) clearTimeout(typeTimeout);
            state.isDialogueOpen = true;
            ui.dialogueBox.style.display = 'block';
            ui.dialogueText.innerHTML = '';
            
            let i = 0;
            const type = () => {
                ui.dialogueText.innerHTML += text.charAt(i);
                i++;
                if(i < text.length) typeTimeout = setTimeout(type, 40);
            };
            type();
        }

        ui.nextBtn.addEventListener('click', () => {
            if(typeTimeout) clearTimeout(typeTimeout);
            ui.dialogueBox.style.display = 'none';
            state.isDialogueOpen = false;
        });

        function endGame() {
            state.isRunning = false;
            ui.hud.style.opacity = '0';
            ui.dialogueBox.style.display = 'none';
            ui.endScreen.classList.add('active');
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Init
        update();

    </script>
</body>
</html>
